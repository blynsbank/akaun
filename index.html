<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blyns Bank - Laman Utama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        :root {
            --primary-color: #0d9488;
            --primary-light: #2dd4bf;
            --bg-dark: #0f0f13;
            --bg-card: #16161a;
            --text-light: #e0e0e3;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 440px;
            background: var(--bg-dark);
            position: relative;
            color: var(--text-light);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Ambient Blobs */
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            z-index: 0;
            opacity: 0.2;
            pointer-events: none;
        }
        .blob-1 { top: -15%; left: -30%; width: 350px; height: 350px; background: var(--primary-color); }
        .blob-2 { bottom: -15%; right: -30%; width: 300px; height: 300px; background: #3b82f6; }

        .sticky-header {
            background-color: var(--bg-dark);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        /* Animated Gradient Balance Card */
        .balance-card {
            background: linear-gradient(-45deg, #0f766e, #0d9488, #115e59, #134e4a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            box-shadow: 0 20px 40px -10px rgba(13, 148, 136, 0.5);
            position: relative;
            z-index: 10;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Interactive Elements */
        .btn-interactive {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.2s;
        }
        .btn-interactive:active {
            transform: scale(0.92);
        }

        /* Action Tiles (Icon Only) */
        .action-tile-icon {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            aspect-ratio: 1/1; /* Makes it a square */
            border-radius: 20px;
            transition: all 0.2s ease;
        }
        .action-tile-icon:active {
            transform: scale(0.95);
            border-color: var(--primary-light);
            background: rgba(255, 255, 255, 0.08);
        }

        /* Footer Nav with Gradient & Shadow */
        .bottom-nav {
            background: rgba(15, 15, 19, 0.85);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8); /* Deep shadow */
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 440px;
            z-index: 30;
        }
        
        /* Gradient line at top of footer */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        .nav-item { color: #6b7280; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-item:active { transform: scale(0.85); }
        .nav-item.active { color: var(--primary-light); text-shadow: 0 0 10px rgba(45, 212, 191, 0.5); }

        /* Floating Pay Button in Footer */
        .nav-pay-btn {
            background: linear-gradient(135deg, #0d9488, #0f766e);
            border: 4px solid var(--bg-dark);
            box-shadow: 0 0 15px rgba(13, 148, 136, 0.4);
            transform: translateY(-20px);
            transition: all 0.2s ease;
        }
        .nav-pay-btn:active {
            transform: translateY(-20px) scale(0.9);
            box-shadow: 0 0 5px rgba(13, 148, 136, 0.6);
        }

        /* PIN Screen Styles */
        #pinContainer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .pin-dot {
            width: 16px; height: 16px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            transition: 0.2s;
        }
        .pin-dot.filled { background: var(--primary-light); border-color: var(--primary-light); box-shadow: 0 0 10px var(--primary-color); }
        .keypad-btn {
            width: 70px; height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            font-size: 24px; font-weight: 600;
            color: white;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s ease;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
        }
        .keypad-btn:active { 
            background: rgba(255, 255, 255, 0.2); 
            transform: scale(0.9);
            border-color: var(--primary-light);
        }

        /* Scrollable Area */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 120px; /* More space for footer */
        }
        .content-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Background aesthetic elements -->
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>

        <!-- ================= PIN SCREEN (Overlay) ================= -->
        <div id="pinContainer" class="hidden">
            <div class="mb-8 text-center">
                <img src="https://i.postimg.cc/QdHXM5RS/Blyns-Bank-Head-Logo.png" alt="Logo" class="h-12 w-auto mb-6 mx-auto filter brightness-110">
                <h2 class="text-xl text-white font-semibold">Masukkan PIN Keselamatan</h2>
                <p class="text-sm text-gray-400 mt-2">Sila sahkan identiti anda</p>
            </div>

            <!-- PIN Dots -->
            <div class="flex space-x-4 mb-10">
                <div class="pin-dot" id="dot1"></div>
                <div class="pin-dot" id="dot2"></div>
                <div class="pin-dot" id="dot3"></div>
                <div class="pin-dot" id="dot4"></div>
                <div class="pin-dot" id="dot5"></div>
                <div class="pin-dot" id="dot6"></div>
            </div>

            <p id="pinErrorMsg" class="text-red-500 text-sm mb-4 h-5 font-medium"></p>

            <!-- Keypad -->
            <div class="grid grid-cols-3 gap-6">
                <div class="keypad-btn" onclick="addPin(1)">1</div>
                <div class="keypad-btn" onclick="addPin(2)">2</div>
                <div class="keypad-btn" onclick="addPin(3)">3</div>
                <div class="keypad-btn" onclick="addPin(4)">4</div>
                <div class="keypad-btn" onclick="addPin(5)">5</div>
                <div class="keypad-btn" onclick="addPin(6)">6</div>
                <div class="keypad-btn" onclick="addPin(7)">7</div>
                <div class="keypad-btn" onclick="addPin(8)">8</div>
                <div class="keypad-btn" onclick="addPin(9)">9</div>
                <div class="keypad-btn bg-transparent"></div>
                <div class="keypad-btn" onclick="addPin(0)">0</div>
                <div class="keypad-btn bg-transparent text-red-400" onclick="deletePin()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z" /><line x1="18" y1="9" x2="12" y2="15" /><line x1="12" y1="9" x2="18" y2="15" /></svg>
                </div>
            </div>
        </div>

        <!-- ================= MAIN DASHBOARD ================= -->
        <div id="dashboardContainer" class="hidden flex flex-col h-full">
            <!-- Sticky Header -->
            <header class="sticky-header sticky top-0 z-20 px-6 py-4 flex items-center justify-between">
                <img src="https://i.postimg.cc/QdHXM5RS/Blyns-Bank-Head-Logo.png" alt="Blyns Bank" class="h-8 w-auto filter brightness-110">
                <button id="btnLogout" onclick="handleLogout()" class="btn-interactive text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-white/5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><path d="M16 17l5-5-5-5" /><path d="M21 12H9" /></svg>
                </button>
            </header>

            <!-- Scrollable Content -->
            <div class="content-scroll p-6 relative z-10">
                <!-- Welcome Section -->
                <div class="mb-6 flex justify-between items-end">
                    <div>
                        <p class="text-sm text-gray-400 font-light">Selamat Datang,</p>
                        <h1 class="text-2xl font-bold text-white tracking-tight" id="welcomeNameDisplay">Pengguna</h1>
                    </div>
                </div>

                <!-- Balance Card -->
                <div class="balance-card p-6 rounded-3xl mb-10 transform transition duration-300">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-white text-xs opacity-80 font-medium mb-1">Baki Semasa</p>
                            <h2 class="text-4xl font-extrabold text-white tracking-tight">
                                RM <span id="currentBalance">00.00</span>
                            </h2>
                        </div>
                        <button id="btnToggleBalance" class="btn-interactive text-white opacity-80 hover:opacity-100 p-1">
                            <svg id="iconEye" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>
                            <svg id="iconEyeOff" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hidden"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><line x1="2" x2="22" y1="2" y2="22" /></svg>
                        </button>
                    </div>

                    <p class="text-xs text-white opacity-60 font-medium mb-6">
                        <span id="accountNumberShown">xxxxxxxxxx</span>
                        <span id="accountNumberHidden" class="hidden">xxxxxxxxxx</span>
                    </p>

                    <div class="flex justify-between items-center border-t border-white/20 pt-4">
                        <span class="text-white font-bold italic text-lg tracking-wider">Blyns+</span>
                        <button onclick="handleTileClick('Tambah Wang')" class="btn-interactive bg-white text-teal-700 px-5 py-2 rounded-full text-xs font-bold shadow-lg">
                            + Tambah
                        </button>
                    </div>
                </div>

                <!-- Action Section -->
                <div class="mb-4">
                    <h3 class="text-white text-md font-semibold mb-4 pl-1 flex items-center gap-2">
                        Pilihan Lain
                        <div class="h-px bg-gray-700 flex-grow ml-2"></div>
                    </h3>
                    
                    <!-- NEW TILES GRID LAYOUT -->
                    <div class="grid grid-cols-4 gap-4 justify-between">
                        <!-- Pindahkan Wang -->
                        <div class="flex flex-col items-center gap-2">
                            <button class="action-tile-icon" onclick="handleTileClick('Pindah')">
                                <div class="p-3 rounded-full bg-teal-500/10 text-teal-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 17 5-5-5-5" /><path d="M2 12h18" /></svg>
                                </div>
                            </button>
                            <span class="text-[11px] font-medium text-gray-400 text-center leading-tight">Pindah<br>Wang</span>
                        </div>

                        <!-- Kad Saya -->
                        <div class="flex flex-col items-center gap-2">
                            <button class="action-tile-icon" onclick="handleTileClick('Kad Saya')">
                                <div class="p-3 rounded-full bg-blue-500/10 text-blue-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></svg>
                                </div>
                            </button>
                            <span class="text-[11px] font-medium text-gray-400 text-center leading-tight">Kad<br>Saya</span>
                        </div>

                        <!-- Placeholder 1 (Future) -->
                        <div class="flex flex-col items-center gap-2 opacity-30 pointer-events-none grayscale">
                             <div class="action-tile-icon border-dashed">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                             </div>
                             <span class="text-[11px] font-medium text-gray-500 text-center">Lagi</span>
                        </div>
                         
                         <!-- Placeholder 2 (Future) -->
                         <div class="flex flex-col items-center gap-2 opacity-30 pointer-events-none grayscale">
                            <div class="action-tile-icon border-dashed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            </div>
                            <span class="text-[11px] font-medium text-gray-500 text-center">Lagi</span>
                       </div>
                    </div>
                </div>

                <div class="text-center mt-8 pb-4">
                    <p class="text-[10px] text-gray-600 tracking-wider uppercase">Kemas kini akan datang</p>
                </div>
            </div>

            <!-- Sticky Footer Navigation (Enhanced) -->
            <nav class="bottom-nav flex justify-between items-end px-8 pb-4 pt-2">
                <button onclick="window.scrollTo(0,0)" class="nav-item active flex flex-col items-center gap-1 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>
                    <span class="text-[10px] font-medium">Home</span>
                </button>
                
                <!-- Raised Pay Button -->
                <button onclick="handleTileClick('Bayar')" class="nav-pay-btn rounded-full p-4 flex items-center justify-center text-white mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></svg>
                </button>

                <button onclick="handleTileClick('Akaun Saya')" class="nav-item flex flex-col items-center gap-1 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>
                    <span class="text-[10px] font-medium">Akaun</span>
                </button>
            </nav>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBpIKSxSnYfvBQia3rlOseBtnSVqThX18c",
            authDomain: "superblyns.firebaseapp.com",
            projectId: "superblyns",
            storageBucket: "superblyns.appspot.com",
            messagingSenderId: "1089867637612",
            appId: "1:1089867637612:web:551d76367b4cfbb6fd4949"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Refs
        const pinContainer = document.getElementById('pinContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const balanceSpan = document.getElementById('currentBalance');
        const accountNumberShown = document.getElementById('accountNumberShown');
        const accountNumberHidden = document.getElementById('accountNumberHidden');
        const welcomeName = document.getElementById('welcomeNameDisplay');
        const btnToggleBalance = document.getElementById('btnToggleBalance');
        const iconEye = document.getElementById('iconEye');
        const iconEyeOff = document.getElementById('iconEyeOff');
        const pinErrorMsg = document.getElementById('pinErrorMsg');

        let userBalance = "0.00";
        let activated = false;
        let isBalanceHidden = false;
        let dbPinHash = "";
        let currentPinInput = "";
        let pinAttempts = 0;

        // LOGOUT
        async function handleLogout() {
            try { await signOut(auth); } catch (error) { console.error("Logout Error:", error); }
            window.location.href = "https://blynsbank.github.io/logmasuk/";
        }
        window.handleLogout = handleLogout;

        // TILE NAVIGATION
        window.handleTileClick = (actionName) => {
            const blockedTiles = ["Bayar", "Tambah Wang", "Pindah", "Kad Saya"];
            if (!activated && blockedTiles.includes(actionName)) {
                console.log("ALERT: Akaun belum aktif.");
                return;
            }
            const urls = {
                "Bayar": "https://blynsbank.github.io/bayar/",
                "Tambah Wang": "https://blynsbank.github.io/tambahwang/",
                "Pindah": "https://blynsbank.github.io/pindahwang/",
                "Aktifkan": "https://blynsbank.github.io/aktivasi/",
                "Akaun Saya": "https://blynsbank.github.io/akaunsaya/",
                "Kad Saya": "https://blynsbank.github.io/kadsaya/"
            };
            if (urls[actionName]) window.location.href = urls[actionName];
        };

        // SHOW / HIDE BALANCE
        btnToggleBalance?.addEventListener('click', () => {
            isBalanceHidden = !isBalanceHidden;
            balanceSpan.textContent = isBalanceHidden ? "XXXXX.XX" : userBalance;
            accountNumberShown.classList.toggle('hidden', isBalanceHidden);
            accountNumberHidden.classList.toggle('hidden', !isBalanceHidden);
            iconEye.classList.toggle('hidden', isBalanceHidden);
            iconEyeOff.classList.toggle('hidden', !isBalanceHidden);
        });

        // ------------------ PIN LOGIC ------------------ //

        // Hashing Helper
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Add PIN Digit
        window.addPin = async (digit) => {
            if (currentPinInput.length < 6) {
                currentPinInput += digit;
                updatePinDots();
                if (currentPinInput.length === 6) verifyPin();
            }
        };

        // Delete Digit
        window.deletePin = () => {
            if (currentPinInput.length > 0) {
                currentPinInput = currentPinInput.slice(0, -1);
                updatePinDots();
            }
        };

        // UI PIN DOTS (Fixed: Get elements by ID explicitly)
        function updatePinDots() {
            const dots = [
                document.getElementById('dot1'),
                document.getElementById('dot2'),
                document.getElementById('dot3'),
                document.getElementById('dot4'),
                document.getElementById('dot5'),
                document.getElementById('dot6')
            ];
            dots.forEach((dot, i) => {
                if (dot) dot.classList.toggle("filled", i < currentPinInput.length);
            });
        }

        // Verify PIN (Fixed: Checks both Hash and Plain text)
        async function verifyPin() {
            const hashedInput = await sha256(currentPinInput);

            // Debugging (Boleh tengok console untuk check value)
            console.log("Input PIN:", currentPinInput);
            console.log("Hashed Input:", hashedInput);
            console.log("DB Value:", dbPinHash);

            // LOGIC FIX: Check if matches Hash OR matches Plain Text
            // This ensures it works if you stored "123456" OR the hashed version in DB
            if (hashedInput === dbPinHash || currentPinInput === dbPinHash) {
                console.log("PIN Verified! Unlocking...");
                pinErrorMsg.textContent = "";
                
                // Force UI Update
                pinContainer.style.display = 'none'; // Safer than just classList
                pinContainer.classList.add("hidden");
                dashboardContainer.classList.remove("hidden");

                currentPinInput = "";
                updatePinDots();
            } else {
                console.log("PIN Failed.");
                pinAttempts++;
                pinErrorMsg.textContent = "PIN salah, cuba lagi.";
                currentPinInput = "";
                updatePinDots();

                // Shake animation
                const dotContainer = document.querySelector('#pinContainer .flex');
                if(dotContainer) {
                    dotContainer.style.transform = "translateX(10px)";
                    setTimeout(() => dotContainer.style.transform = "translateX(-10px)", 50);
                    setTimeout(() => dotContainer.style.transform = "translateX(0)", 100);
                }

                if (pinAttempts >= 5) {
                    alert("Terlalu banyak cubaan. Log keluar...");
                    await handleLogout();
                }
            }
        }

        // AUTH LISTEN
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "https://blynsbank.github.io/logmasuk/";
                return;
            }

            // Ensure PIN screen is visible on load
            pinContainer.style.display = 'flex';
            pinContainer.classList.remove("hidden");
            dashboardContainer.classList.add("hidden");

            try {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (!snap.exists()) {
                    console.log("User doc tak wujud.");
                    return;
                }

                const data = snap.data();
                welcomeName.textContent = data.fullname || "Pengguna";
                userBalance = data.balance || "0.00";
                balanceSpan.textContent = userBalance;
                
                // Handle different field names for card number
                accountNumberShown.textContent = data.cardnumber || data.cardNumb || "XXXXXXXXXX";

                activated = data.activated || false;
                dbPinHash = data.pin || "";

            } catch (e) {
                console.error("Error fetching user data:", e);
            }
        });
    </script>
</body>

</html>
