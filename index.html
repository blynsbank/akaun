<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blyns Bank - Laman Utama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        :root {
            /* Primary Color: Teal */
            --primary-color: #0d9488;
            --primary-light: #2dd4bf;
            /* Dark Background Palette */
            --bg-dark: #0f0f13;
            --bg-card: #16161a;
            --text-light: #e0e0e3;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 440px;
            background: var(--bg-dark);
            position: relative;
            color: var(--text-light);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Ambient Blobs */
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            z-index: 0;
            opacity: 0.2;
            pointer-events: none;
        }

        .blob-1 {
            top: -15%;
            left: -30%;
            width: 350px;
            height: 350px;
            background: var(--primary-color);
        }

        .blob-2 {
            bottom: -15%;
            right: -30%;
            width: 300px;
            height: 300px;
            background: #3b82f6;
        }

        .sticky-header {
            background-color: var(--bg-dark);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        /* Animated Gradient Balance Card */
        .balance-card {
            background: linear-gradient(-45deg, #0f766e, #0d9488, #115e59, #134e4a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            box-shadow: 0 20px 40px -10px rgba(13, 148, 136, 0.5);
            position: relative;
            z-index: 10;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Action Tiles */
        .action-tile {
            background: var(--bg-card);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .action-tile:active {
            transform: scale(0.98);
        }

        /* Footer Nav */
        .bottom-nav {
            background: rgba(15, 15, 19, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            color: #888;
            transition: 0.3s;
        }

        .nav-item.active {
            color: var(--primary-light);
        }

        /* PIN Screen Styles */
        #pinContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            transition: 0.2s;
        }

        .pin-dot.filled {
            background: var(--primary-light);
            border-color: var(--primary-light);
        }

        .keypad-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            font-size: 24px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .keypad-btn:active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Scrollable Area */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px;
            /* Space for footer */
        }

        /* Hide scrollbar */
        .content-scroll::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Background aesthetic elements -->
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>

        <!-- ================= PIN SCREEN (Overlay) ================= -->
        <div id="pinContainer" class="hidden">
            <div class="mb-8 text-center">
                <img src="https://i.postimg.cc/QdHXM5RS/Blyns-Bank-Head-Logo.png" alt="Logo" class="h-12 w-auto mb-6 mx-auto filter brightness-110">
                <h2 class="text-xl text-white font-semibold">Masukkan PIN Keselamatan</h2>
                <p class="text-sm text-gray-400 mt-2">Sila sahkan identiti anda</p>
            </div>

            <!-- PIN Dots -->
            <div class="flex space-x-4 mb-10">
                <div class="pin-dot" id="dot1"></div>
                <div class="pin-dot" id="dot2"></div>
                <div class="pin-dot" id="dot3"></div>
                <div class="pin-dot" id="dot4"></div>
                <div class="pin-dot" id="dot5"></div>
                <div class="pin-dot" id="dot6"></div>
            </div>

            <p id="pinErrorMsg" class="text-red-500 text-sm mb-4 h-5"></p>

            <!-- Keypad -->
            <div class="grid grid-cols-3 gap-6">
                <div class="keypad-btn" onclick="addPin(1)">1</div>
                <div class="keypad-btn" onclick="addPin(2)">2</div>
                <div class="keypad-btn" onclick="addPin(3)">3</div>
                <div class="keypad-btn" onclick="addPin(4)">4</div>
                <div class="keypad-btn" onclick="addPin(5)">5</div>
                <div class="keypad-btn" onclick="addPin(6)">6</div>
                <div class="keypad-btn" onclick="addPin(7)">7</div>
                <div class="keypad-btn" onclick="addPin(8)">8</div>
                <div class="keypad-btn" onclick="addPin(9)">9</div>
                <div class="keypad-btn bg-transparent"></div>
                <div class="keypad-btn" onclick="addPin(0)">0</div>
                <div class="keypad-btn bg-transparent text-red-400" onclick="deletePin()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z" />
                        <line x1="18" y1="9" x2="12" y2="15" />
                        <line x1="12" y1="9" x2="18" y2="15" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- ================= MAIN DASHBOARD ================= -->
        <div id="dashboardContainer" class="hidden flex flex-col h-full">
            <!-- Sticky Header -->
            <header class="sticky-header sticky top-0 z-20 px-6 py-4 flex items-center justify-between">
                <img src="https://i.postimg.cc/QdHXM5RS/Blyns-Bank-Head-Logo.png" alt="Blyns Bank" class="h-8 w-auto filter brightness-110">
                <button id="btnLogout" onclick="handleLogout()" class="text-gray-400 hover:text-red-500 transition duration-150 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <path d="M16 17l5-5-5-5" />
                        <path d="M21 12H9" />
                    </svg>
                </button>
            </header>

            <!-- Scrollable Content -->
            <div class="content-scroll p-6 relative z-10">
                <!-- Welcome Section -->
                <div class="mb-6 flex justify-between items-end">
                    <div>
                        <p class="text-sm text-gray-400 font-light">Selamat Datang,</p>
                        <h1 class="text-2xl font-bold text-white tracking-tight" id="welcomeNameDisplay">Pengguna</h1>
                    </div>
                </div>

                <!-- Balance Card -->
                <div class="balance-card p-6 rounded-3xl mb-8 transform transition duration-300">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-white text-xs opacity-80 font-medium mb-1">Baki Semasa</p>
                            <h2 class="text-4xl font-extrabold text-white tracking-tight">
                                RM <span id="currentBalance">00.00</span>
                            </h2>
                        </div>
                        <button id="btnToggleBalance" class="text-white opacity-80 hover:opacity-100 transition">
                            <svg id="iconEye" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <svg id="iconEyeOff" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hidden">
                                <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                                <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" />
                                <line x1="2" x2="22" y1="2" y2="22" />
                            </svg>
                        </button>
                    </div>

                    <p class="text-xs text-white opacity-60 font-medium mb-6">
                        <span id="accountNumberShown">xxxxxxxxxx</span>
                        <span id="accountNumberHidden" class="hidden">xxxxxxxxxx</span>
                    </p>

                    <div class="flex justify-between items-center border-t border-white/20 pt-4">
                        <span class="text-white font-bold italic text-lg tracking-wider">Blyns+</span>
                        <button onclick="handleTileClick('Tambah Wang')" class="bg-white text-teal-700 px-4 py-1.5 rounded-full text-xs font-bold shadow-lg hover:bg-gray-100 transition transform hover:scale-105">
                            + Tambah
                        </button>
                    </div>
                </div>

                <!-- Action Section -->
                <div class="mb-4">
                    <h3 class="text-white text-md font-semibold mb-3 pl-1">Pilihan Lain</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Pindahkan Wang -->
                        <button class="action-tile p-4 rounded-2xl flex flex-col items-start justify-between h-28" onclick="handleTileClick('Pindah')">
                            <div class="p-2 rounded-full bg-teal-500/20 text-teal-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m15 17 5-5-5-5" />
                                    <path d="M2 12h18" />
                                </svg>
                            </div>
                            <span class="text-sm font-semibold text-white">Pindahkan<br>Wang</span>
                        </button>

                        <!-- Kad Saya (New) -->
                        <button class="action-tile p-4 rounded-2xl flex flex-col items-start justify-between h-28" onclick="handleTileClick('Kad Saya')">
                            <div class="p-2 rounded-full bg-blue-500/20 text-blue-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="20" height="14" x="2" y="5" rx="2" />
                                    <line x1="2" x2="22" y1="10" y2="10" />
                                </svg>
                            </div>
                            <span class="text-sm font-semibold text-white">Kad<br>Saya</span>
                        </button>
                    </div>
                </div>

                <div class="text-center mt-8 pb-4">
                    <p class="text-xs text-gray-500 italic">Kemas kini akan datang.</p>
                </div>
            </div>

            <!-- Sticky Footer Navigation -->
            <nav class="bottom-nav fixed bottom-0 w-full max-w-[440px] z-30 px-6 py-3 flex justify-between items-center">
                <button onclick="window.scrollTo(0,0)" class="nav-item active flex flex-col items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" />
                    </svg>
                    <span class="text-[10px] font-medium">Home</span>
                </button>

                <button onclick="handleTileClick('Bayar')" class="nav-item flex flex-col items-center gap-1">
                    <div class="bg-teal-600 rounded-full p-3 -mt-8 shadow-lg shadow-teal-900/50 border-4 border-[#0f0f13] text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" x2="12" y1="2" y2="22" />
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-medium text-white">Bayar</span>
                </button>

                <button onclick="handleTileClick('Akaun Saya')" class="nav-item flex flex-col items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                    <span class="text-[10px] font-medium">Akaun</span>
                </button>
            </nav>
        </div>
    </div>

    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBpIKSxSnYfvBQia3rlOseBtnSVqThX18c",
            authDomain: "superblyns.firebaseapp.com",
            projectId: "superblyns",
            storageBucket: "superblyns.appspot.com",
            messagingSenderId: "1089867637612",
            appId: "1:1089867637612:web:551d76367b4cfbb6fd4949"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Refs
        const pinContainer = document.getElementById('pinContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const balanceSpan = document.getElementById('currentBalance');
        const accountNumberShown = document.getElementById('accountNumberShown');
        const accountNumberHidden = document.getElementById('accountNumberHidden');
        const welcomeName = document.getElementById('welcomeNameDisplay');
        const btnToggleBalance = document.getElementById('btnToggleBalance');
        const iconEye = document.getElementById('iconEye');
        const iconEyeOff = document.getElementById('iconEyeOff');
        const pinErrorMsg = document.getElementById('pinErrorMsg');

        let userBalance = "0.00";
        let activated = false;
        let isBalanceHidden = false;
        let dbPinHash = ""; // Stores the hashed PIN from Firebase
        let currentPinInput = "";
        let pinAttempts = 0;

        // Logout
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout Error:", error);
            }
            window.location.href = "https://blynsbank.github.io/logmasuk/";
        }
        window.handleLogout = handleLogout;

        // Navigation Handler
        window.handleTileClick = (actionName) => {
            const blockedTiles = ["Bayar", "Tambah Wang", "Pindah", "Kad Saya"];
            if (!activated && blockedTiles.includes(actionName)) {
                console.log("ALERT: Akaun belum aktif.");
                return;
            }
            const urls = {
                "Bayar": "https://blynsbank.github.io/bayar/",
                "Tambah Wang": "https://blynsbank.github.io/tambahwang/",
                "Pindah": "https://blynsbank.github.io/pindahwang/",
                "Aktifkan": "https://blynsbank.github.io/aktivasi/",
                "Akaun Saya": "https://blynsbank.github.io/akaunsaya/",
                "Kad Saya": "https://blynsbank.github.io/kadsaya/" // New URL
            }
            if (urls[actionName]) window.location.href = urls[actionName];
        };

        // Balance Toggle
        btnToggleBalance?.addEventListener('click', () => {
            isBalanceHidden = !isBalanceHidden;
            balanceSpan.textContent = isBalanceHidden ? "XXXXX.XX" : userBalance;
            accountNumberShown.classList.toggle('hidden', isBalanceHidden);
            accountNumberHidden.classList.toggle('hidden', !isBalanceHidden);
            iconEye.classList.toggle('hidden', isBalanceHidden);
            iconEyeOff.classList.toggle('hidden', !isBalanceHidden);
        });

        // ------------------ PIN LOGIC ------------------ //

        // Helper: SHA-256 Hashing
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        window.addPin = async (digit) => {
            if (currentPinInput.length < 6) {
                currentPinInput += digit;
                updatePinDots();
                if (currentPinInput.length === 6) {
                    await verifyPin();
                }
            }
        };

        window.deletePin = () => {
            if (currentPinInput.length > 0) {
                currentPinInput = currentPinInput.slice(0, -1);
                updatePinDots();
            }
        };

        // Update PIN Dots
        function updatePinDots() {
            for (let i = 1; i <= 6; i++) {
                const dot = document.getElementById(`dot${i}`);
                if (i <= currentPinInput.length) {
                    dot.classList.add("filled");
                } else {
                    dot.classList.remove("filled");
                }
            }
        }

        // Verify PIN
        async function verifyPin() {
            const hashInput = await sha256(currentPinInput);

            if (hashInput === dbPinHash) {
                pinErrorMsg.textContent = "";
                pinContainer.classList.add("hidden");
                dashboardContainer.classList.remove("hidden");
                currentPinInput = "";
                updatePinDots();
            } else {
                pinAttempts++;
                pinErrorMsg.textContent = "PIN salah, cuba lagi.";

                currentPinInput = "";
                updatePinDots();

                if (pinAttempts >= 5) {
                    pinErrorMsg.textContent = "Terlalu banyak cubaan. Akaun dikunci sementara.";
                }
            }
        }

        // AUTH LISTENER
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "https://blynsbank.github.io/logmasuk/";
                return;
            }

            const docSnap = await getDoc(doc(db, "users", user.uid));

            if (!docSnap.exists()) {
                console.log("User doc tak wujud.");
                return;
            }

            const data = docSnap.data();

            welcomeName.textContent = data.fullname;
            userBalance = data.balance;
            balanceSpan.textContent = userBalance;
            accountNumberShown.textContent = data.cardNumb;

            activated = data.activated || false;
            dbPinHash = data.pin || "";

            // First show PIN screen
            pinContainer.classList.remove("hidden");
            dashboardContainer.classList.add("hidden");
        });
    </script>
</body>

</html>
